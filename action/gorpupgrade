#!/usr/bin/env bash

### [GORPUPDATE] ##################################################
#   Description:  Action script to setup Gorp update worker.
#   Parameters:   None

############################ [WARNING] ############################
##    No part of this script is designed to be user-editable.    ##
##   This script is OVERWRITTEN any time a Gorp update is run.   ##
###################################################################



#### GUARDS ################

### KEY GUARD

if [[ "$1" != "pleasedontdothis" ]]; then
    echo "mcarchiveworld: Not intended to be run directly. Exit (13)."
    exit 13
fi



### DO WE EVEN NEED TO UPGRADE?

if [[ "$INSTALLED" == "$LATEST_VER" ]]; then
    echo "Gorp is already on the latest version."
    exit 0
fi



### GET SUDO PERMISSIONS

echo "To upgrade, Gorp will use sudo."
sudo whoami > /dev/null



#### SCRIPT PARAMETERS ################

source /usr/local/bin/gorpmc/worker/i_getconfigparams.sh

INSTALLED=$(gorp -v | cut -d ' ' -f3)
LATEST_TAG=$(curl -s https://api.github.com/repos/LanceNickel/Gorp/releases/latest | jq -r .tag_name)
LATEST_VER=$(echo $LATEST_TAG | cut -c 2-)



####



### TEMP DIRECTORY

rm -rf $HOMEDIR/tmp/
mkdir -p $HOMEDIR/tmp/



### DOWNLOAD THE LATEST RELEASE

echo "Downloading latest release..."

cd $HOMEDIR/tmp/
wget -q https://github.com/LanceNickel/Gorp/archive/refs/tags/$LATEST_TAG.tar.gz

tar -xf $LATEST_TAG.tar.gz > /dev/null

mkdir -p ./updatefiles/
mv ./Gorp-$LATEST_VER/* ./updatefiles/





### RUN UPDATE WORKER

chmod +x $HOMEDIR/tmp/updatefiles/upgrade.sh
$HOMEDIR/tmp/updatefiles/upgrade.sh pleasedontdothis



### CLEAN UP

rm -rf $HOMEDIR/tmp/